import mss
import socket
import numpy
import cv2
import zlib

SCALE_FACTOR = 0.7
MAXDGRAMSIZE = 65507
ADDRESS = ("192.168.122.1", 9999)
client = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

with mss.mss() as sct:
    monitor = 1
    while True:
        img = sct.grab(sct.monitors[monitor])
        img = numpy.array(img)
        img_rgb = img[:, :, :3]
        new_width = int(img_rgb.shape[1] * SCALE_FACTOR)
        new_height = int(img_rgb.shape[0] * SCALE_FACTOR)
        resized_img = cv2.resize(img_rgb, (new_width, new_height))
        img = cv2.cvtColor(img, cv2.COLOR_BGRA2BGR)
        _, buffer = cv2.imencode('.jpg', resized_img, [int(cv2.IMWRITE_JPEG_QUALITY), 50])
        compressed = zlib.compress(buffer.tobytes())
        if len(compressed) > MAXDGRAMSIZE:
            print("size too big")
            continue
        client.sendto(compressed, ADDRESS)
